---
// pages/blog/[slug].astro
import { getCollection } from 'astro:content';
import BlogLayout from '../../layouts/BlogLayout.astro';
import CaesarVisualizer from '../../components/visualizers/CaesarVisualizer.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// --- YOUR ORIGINAL LOGIC IS PRESERVED ---
const {
  title,
  description,
  pubDate,
  updatedDate,
  author,
  image,
  imageAlt,
  tags = [],
  category,
  readTime,
  difficulty = 'beginner',
  prerequisites = [],
  learningObjectives = [],
  featured = false,
  draft = false,
  canonicalURL,
  socialImage,
  articleType = 'article'
} = entry.data;

if (draft && import.meta.env.PROD) {
  return Astro.redirect('/blog');
}

const calculateReadTime = (content: string) => {
  const wordsPerMinute = 200;
  if (!content) return 0;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
};

const calculatedReadTime = readTime || calculateReadTime(entry.body);

const canonicalUrl = canonicalURL || new URL(Astro.url.pathname, Astro.site).href;

const socialImageUrl = socialImage || image || '/images/default-blog-image.jpg';
---

<BlogLayout
  title={title}
  description={description}
  pubDate={pubDate}
  updatedDate={updatedDate}
  author={author}
  image={image}
  imageAlt={imageAlt}
  tags={tags}
  category={category}
  readTime={calculatedReadTime}
  difficulty={difficulty}
  prerequisites={prerequisites}
  learningObjectives={learningObjectives}
  canonicalURL={canonicalUrl}
  socialImage={socialImageUrl}
  articleType={articleType}
>
  {/* --- THIS IS THE ONLY CHANGE --- */}
  {/* The Visualizer logic now comes BEFORE the main content */}

  {entry.data.visualizer === 'CaesarVisualizer' && (
    <div class="visualizer-section mb-12 pb-8 border-b-2 border-gray-300 dark:border-gray-700 border-dashed">
      <h2 class="text-3xl font-bold mb-6 text-center text-gray-900 dark:text-white">
        Interactive Visualizer
      </h2>
      <CaesarVisualizer />
    </div>
  )}

  {/* This renders the actual content from your .md file */}
  <Content />

</BlogLayout>